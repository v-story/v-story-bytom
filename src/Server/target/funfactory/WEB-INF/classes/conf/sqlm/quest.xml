<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlm SYSTEM "http://10.95.26.153/dtd/sqlm_2_1.dtd" [
]>
<sqlm   ver="2.1">
	<module name="quest" desc="quest">
		<sql name="quest.SNSQuestSelect" execute="Select" type="PreparedStatement" desc="SNSQuestSelect">
			<param name="ACCOUNTPK"	required="yes" 	desc="" />
			<puts>
				SELECT
					A.SNS_QUEST_SEQ AS QUEST_SEQ,
					B.CONNECT_YN AS QUEST_CONNECT_YN,
					A.QUEST_TYPE AS QUEST_TYPE,
					A.STEP AS QUEST_STEP,
					A.TEAM_ACCOUNTPK AS QUEST_TEAM_ACCOUNTPK,
					A.REG_TIME AS QUEST_REG_TIME
				FROM
				(	
					SELECT SNS_QUEST_SEQ, ACCOUNTPK, QUEST_TYPE, STEP, TEAM_ACCOUNTPK, TIMESTAMPDIFF(SECOND, NOW(), LIMIT_TIME)AS 'REG_TIME' 
					FROM TB_SNS_QUEST 
					WHERE ACCOUNTPK = $ACCOUNTPK AND LIMIT_TIME > NOW()
				) A INNER JOIN TB_USER B
				ON B.ACCOUNTPK = A.TEAM_ACCOUNTPK
			</puts>
		</sql>	
		<sql name="quest.SNSQuestSelect101" execute="Select" type="PreparedStatement" desc="SNSQuestSelect">
			<param name="ACCOUNTPK"	required="yes" 	desc="" />
			<puts>
				SELECT
					A.SNS_QUEST_SEQ AS QUEST_SEQ,
					B.CONNECT_YN AS QUEST_CONNECT_YN,
					A.QUEST_TYPE AS QUEST_TYPE,
					A.STEP AS QUEST_STEP,
					A.TEAM_ACCOUNTPK AS QUEST_TEAM_ACCOUNTPK,
					A.REG_TIME AS QUEST_REG_TIME
				FROM
				(	
					SELECT SNS_QUEST_SEQ, ACCOUNTPK, QUEST_TYPE, STEP, TEAM_ACCOUNTPK, TIMESTAMPDIFF(SECOND, NOW(), LIMIT_TIME)AS 'REG_TIME' 
					FROM TB_SNS_QUEST 
					WHERE ACCOUNTPK = $ACCOUNTPK AND LIMIT_TIME > NOW() AND QUEST_TYPE = 101
				) A INNER JOIN TB_USER B
				ON B.ACCOUNTPK = A.TEAM_ACCOUNTPK
			</puts>
		</sql>
		<sql name="quest.getUserGender" execute="Select" type="PreparedStatement" desc="SNSQuestSelect">
			<param name="ACCOUNTPK"	required="yes" 	desc="" />
			<puts>
				SELECT
					A.GENDER
				FROM  FUNFACTORY_SNS.TB_USER A 
				WHERE A.ACCOUNTPK = $ACCOUNTPK
			</puts>
		</sql>
		<sql name="quest.getUserList" execute="Select" type="PreparedStatement" desc="SNSQuestSelect">
			<param name="ACCOUNTPK"	required="yes" 	desc="" />
			<param name="CNT"	required="yes" 	desc="" />
			<puts>
				SELECT a.ACCOUNTPK 
				FROM 
				(
					SELECT
						GENDER
					FROM  FUNFACTORY_GAME.TB_USER
					WHERE ACCOUNTPK = $ACCOUNTPK
				)b, FUNFACTORY_GAME.TB_USER a
				WHERE a.GENDER != b.GENDER AND a.GENDER != 0  AND a.AVATAR_CD IS NOT NULL AND a.AVATAR_CD != 0 AND a.ACCOUNTPK != $ACCOUNTPK
					 AND a.ACCOUNTPK NOT IN (SELECT TEAM_ACCOUNTPK FROM FUNFACTORY_GAME.TB_SNS_QUEST WHERE QUEST_TYPE = 101 AND ACCOUNTPK = $ACCOUNTPK AND LIMIT_TIME > NOW())
					 AND a.ACCOUNTPK NOT IN (SELECT TEAM_ACCOUNTPK FROM FUNFACTORY_GAME.TB_SNS_QUEST_SUB WHERE ACCOUNTPK = $ACCOUNTPK  AND LIMIT_TIME > NOW())
					 AND a.ACCOUNTPK NOT IN (SELECT FRIEND_ACCOUNTPK FROM FUNFACTORY_GAME.TB_SUGGEST_FRIEND WHERE ACCOUNTPK = $ACCOUNTPK  AND LIMIT_TIME > NOW())
				ORDER BY RAND() LIMIT $CNT
			</puts>
		</sql>
		<sql name="quest.SNSQuestSubSelect" execute="Select" type="PreparedStatement" desc="SNSQuestSubSelect">
			<param name="ACCOUNTPK"	required="yes" 	desc="" />
			<param name="QUEST_TYPE"	required="yes" 	desc="" />
			<puts>
				SELECT 
					SNS_QUEST_SUB_SEQ AS SUB_SEQ,
					QUEST_TYPE AS SUB_TYPE,
					STEP AS SUB_STEP,
					TEAM_ACCOUNTPK AS SUB_TEAM_ACCOUNTPK,
					TIMESTAMPDIFF(second, now(), LIMIT_TIME) AS SUB_LIMIT_TIME
				FROM TB_SNS_QUEST_SUB 
				WHERE ACCOUNTPK = $ACCOUNTPK and QUEST_TYPE = $QUEST_TYPE and LIMIT_TIME > NOW()
				ORDER BY ACCOUNTPK
			</puts>
		</sql>	
		
		<sql name="quest.SNSQuestCntSelect" execute="Select" type="PreparedStatement" desc="SNSQuestCntSelect">
			<param name="ACCOUNTPK"	required="yes" 	desc="" />
			<puts>
				SELECT STEP AS QUEST_TEAM_ACCOUNTPK_STEP
				FROM TB_SNS_QUEST 
				WHERE ACCOUNTPK = $ACCOUNTPK and QUEST_TYPE = 101 and LIMIT_TIME > NOW()
			</puts>
		</sql>	
		
		<sql name="quest.SNSQuestFriendVisitSelect1" execute="Select" type="PreparedStatement" desc="방문친구 메인정보 얻기1">
			<param name="ACCOUNTPK"	required="yes" 	desc="" />
			<puts>
				SELECT COUNT(SNS_QUEST_SEQ) AS 'ROWCOUNT'
				FROM TB_SNS_QUEST
				WHERE ACCOUNTPK = $ACCOUNTPK
			</puts>
		</sql>	
		
		<sql name="quest.SNSQuestFriendVisitSelect2" execute="Select" type="PreparedStatement" desc="방문친구 메인정보 얻기(Row가 0이면)">
			<param name="ACCOUNTPK"	required="yes" 	desc="" />
			<puts>	
				SELECT A.TEAM_ACCOUNTPK,A.QUEST_TYPE,A.STEP
				FROM
				(
					SELECT TEAM_ACCOUNTPK,QUEST_TYPE,STEP FROM TB_SNS_QUEST
					WHERE ACCOUNTPK = $ACCOUNTPK
					AND QUEST_TYPE = 101
					ORDER BY SNS_QUEST_SEQ DESC
					LIMIT 1
				) A	   	   
				UNION ALL
				SELECT
					A.TEAM_ACCOUNTPK,
					CASE WHEN A.NO=1 THEN 202 WHEN A.NO=2 THEN 301 END QUEST_TYPE,
					0 AS STEP
				FROM	
				(
					SELECT @RNUM := @RNUM + 1 AS NO,A.*
					FROM
					(
						SELECT 
						ACCOUNTPK AS TEAM_ACCOUNTPK
						FROM TB_USER 
						WHERE ACCOUNTPK NOT IN($ACCOUNTPK)
						AND AVATAR_CD IS NOT NULL
						ORDER BY RAND()
						LIMIT 2
					) A,  ( SELECT @RNUM := 0 ) b		
				) A
			</puts>
		</sql>	
		
		<sql name="quest.SNSQuestFriendVisitSelect3" execute="Select" type="PreparedStatement" desc="방문친구 메인정보 얻기(Row가 1이상)">
			<param name="ACCOUNTPK"	required="yes" 	desc="" />
			<puts>		
				SELECT 
					A.TEAM_ACCOUNTPK AS QUEST_TEAM_ACCOUNTPK,
					A.QUEST_TYPE AS QUEST_TYPE,
					A.STEP AS QUEST_STEP
				FROM
				(
					SELECT 
						A.TEAM_ACCOUNTPK,
						A.QUEST_TYPE,
						A.STEP
					FROM
					(
						SELECT 	TEAM_ACCOUNTPK,
							QUEST_TYPE,
							STEP
						 FROM TB_SNS_QUEST
						WHERE ACCOUNTPK = $ACCOUNTPK
						ORDER BY SNS_QUEST_SEQ DESC
					) A
					LIMIT 0,3
				) A ORDER BY QUEST_TYPE ASC
			</puts>
		</sql>
		<sql name="quest.SNSQuestOpenSelect" execute="Select" type="PreparedStatement" desc="생산퀘스트 강제오픈 정보얻기">
			<param name="ACCOUNTPK"	required="yes" 	desc="" />
			<puts>
				SELECT TIMESTAMPDIFF(second, now(), LIMIT_TIME)as 'LIMIT_TIME' FROM TB_SNS_QUEST_OPEN WHERE ACCOUNTPK = $ACCOUNTPK and LIMIT_TIME > NOW()
			</puts>
		</sql>
		<sql name="quest.SNSQuestInsertBe" execute="Update" type="PreparedStatement" desc="쇼셜퀘스트 메인등록 3시전">
			<param name="ACCOUNTPK"			required="yes" 	desc="" />
			<param name="QUEST_TYPE"		required="yes" 	desc="" />
			<param name="STEP"				required="yes" 	desc="" />
			<param name="TEAM_ACCOUNTPK"	required="yes" 	desc="" />
			<puts>
				INSERT INTO TB_SNS_QUEST (ACCOUNTPK, QUEST_TYPE, STEP, TEAM_ACCOUNTPK, LIMIT_TIME ) values($ACCOUNTPK, $QUEST_TYPE, $STEP, $TEAM_ACCOUNTPK, DATE_FORMAT(NOW(), '%Y-%m-%d 03:00:00'))
			</puts>
		</sql>
		<sql name="quest.SNSQuestInsertAf" execute="Update" type="PreparedStatement" desc="쇼셜퀘스트 메인등록 3시후">
			<param name="ACCOUNTPK"			required="yes" 	desc="" />
			<param name="QUEST_TYPE"		required="yes" 	desc="" />
			<param name="STEP"				required="yes" 	desc="" />
			<param name="TEAM_ACCOUNTPK"	required="yes" 	desc="" />
			<puts>
				INSERT INTO TB_SNS_QUEST (ACCOUNTPK, QUEST_TYPE, STEP, TEAM_ACCOUNTPK, LIMIT_TIME ) values($ACCOUNTPK, $QUEST_TYPE, $STEP, $TEAM_ACCOUNTPK, DATE_FORMAT(ADDDATE(NOW(), 1), '%Y-%m-%d 03:00:00'))
			</puts>
		</sql>
		<sql name="quest.SNSQuestOpenInsertBe" execute="Update" type="PreparedStatement" desc="생산퀘스트 강제오픈 등록 3시전">
			<param name="ACCOUNTPK"			required="yes" 	desc="" />
			<puts>
				INSERT INTO TB_SNS_QUEST_OPEN(ACCOUNTPK, LIMIT_TIME) VALUES( $ACCOUNTPK, DATE_FORMAT(NOW(), '%Y-%m-%d 03:00:00'))
			</puts>
		</sql>
		<sql name="quest.SNSQuestOpenInsertAf" execute="Update" type="PreparedStatement" desc="생산퀘스트 강제오픈 등록 3시후">
			<param name="ACCOUNTPK"	required="yes" 	desc="" />
			<puts>
				INSERT INTO TB_SNS_QUEST_OPEN(ACCOUNTPK, LIMIT_TIME) VALUES( $ACCOUNTPK, DATE_FORMAT(ADDDATE(NOW(), 1), '%Y-%m-%d 03:00:00'))
			</puts>
		</sql>
		
		<sql name="quest.SNSQuestSubInsertBe" execute="Update" type="PreparedStatement" desc="추천친구 등록 3시전">
			<param name="ACCOUNTPK"			required="yes" 	desc="" />
			<param name="QUEST_TYPE"		required="yes" 	desc="" />
			<param name="STEP"				required="yes" 	desc="" />
			<param name="TEAM_ACCOUNTPK"	required="yes" 	desc="" />
			<puts>
				INSERT INTO TB_SNS_QUEST_SUB(ACCOUNTPK,QUEST_TYPE,STEP,TEAM_ACCOUNTPK,LIMIT_TIME) VALUES ($ACCOUNTPK,$QUEST_TYPE,$STEP,$TEAM_ACCOUNTPK,DATE_FORMAT(NOW(), '%Y-%m-%d 03:00:00'))
			</puts>
		</sql>
		<sql name="quest.SNSQuestSubInsertAf" execute="Update" type="PreparedStatement" desc="추천친구 등록 3시후">
			<param name="ACCOUNTPK"			required="yes" 	desc="" />
			<param name="QUEST_TYPE"		required="yes" 	desc="" />
			<param name="STEP"				required="yes" 	desc="" />
			<param name="TEAM_ACCOUNTPK"	required="yes" 	desc="" />
			<puts>
				INSERT INTO TB_SNS_QUEST_SUB (ACCOUNTPK,QUEST_TYPE,STEP,TEAM_ACCOUNTPK,LIMIT_TIME) VALUES ($ACCOUNTPK,$QUEST_TYPE,$STEP,$TEAM_ACCOUNTPK,DATE_FORMAT(ADDDATE(NOW(), 1), '%Y-%m-%d 03:00:00'))
			</puts>
		</sql>
		
		<sql name="quest.SuggestFriendInsertBe" execute="Update" type="PreparedStatement" desc="SuggestInsertBe">
			<param name="ACCOUNTPK"			required="yes" 	desc="" />
			<param name="FRIEND_ACCOUNTPK"		required="yes" 	desc="" />
			<puts>
				INSERT INTO TB_SUGGEST_FRIEND(ACCOUNTPK, FRIEND_ACCOUNTPK, LIMIT_TIME) VALUES ( $ACCOUNTPK, $FRIEND_ACCOUNTPK, DATE_FORMAT(NOW(), '%Y-%m-%d 03:00:00'))
			</puts>
		</sql>
		<sql name="quest.SuggestFriendInsertAf" execute="Update" type="PreparedStatement" desc="SuggestInsertAf">
			<param name="ACCOUNTPK"			required="yes" 	desc="" />
			<param name="FRIEND_ACCOUNTPK"		required="yes" 	desc="" />
			<puts>
				INSERT INTO TB_SUGGEST_FRIEND(ACCOUNTPK, FRIEND_ACCOUNTPK, LIMIT_TIME) VALUES ( $ACCOUNTPK, $FRIEND_ACCOUNTPK, DATE_FORMAT(ADDDATE(NOW(), 1), '%Y-%m-%d 03:00:00'))
			</puts>
		</sql>
		<sql name="quest.GetSuggestFriendList" execute="Update" type="PreparedStatement" desc="SuggestInsertAf">
			<param name="ACCOUNTPK"			required="yes" 	desc="" />
			<puts>
				SELECT 
					A.FRIEND_ACCOUNTPK,
					B.AVATAR_CD,
					B.CONNECT_YN,
					C.PROF_PIC_NM,
					TO_BASE64(C.INTRODUCE) INTRODUCE
				FROM
				(	
					SELECT 
						FRIEND_ACCOUNTPK 
					FROM TB_SUGGEST_FRIEND 
					WHERE ACCOUNTPK = $ACCOUNTPK AND LIMIT_TIME > NOW()
					ORDER BY SUGGEST_FRIEND_SEQ DESC
					LIMIT 6
					) A INNER JOIN TB_USER B INNER JOIN TB_SNS_USER_INFO C
					ON A.FRIEND_ACCOUNTPK = B.ACCOUNTPK   	
					AND A.FRIEND_ACCOUNTPK = C.ACCOUNTPK   
			</puts>
		</sql>
		
		<sql name="quest.SNSQuestUpdate" execute="Update" type="PreparedStatement" desc="메인 업데이트">
			<param name="SNS_QUEST_SEQ"			required="yes" 	desc="" />
			<param name="STEP"				required="yes" 	desc="" />
			<param name="TEAM_ACCOUNTPK"	required="yes" 	desc="" />
			<puts>
				UPDATE TB_SNS_QUEST SET STEP = $STEP, TEAM_ACCOUNTPK = $TEAM_ACCOUNTPK WHERE SNS_QUEST_SEQ =$SNS_QUEST_SEQ;
			</puts>
		</sql>
		<sql name="quest.SNSQuestSubUpdate" execute="Update" type="PreparedStatement" desc="추천친구 업데이트">
			<param name="SNS_QUEST_SUB_SEQ"	required="yes" 	desc="" />
			<param name="STEP"				required="yes" 	desc="" />
			<param name="TEAM_ACCOUNTPK"	required="yes" 	desc="" />
			<puts>
				UPDATE TB_SNS_QUEST_SUB SET STEP = $STEP, TEAM_ACCOUNTPK = $TEAM_ACCOUNTPK WHERE SNS_QUEST_SUB_SEQ = $SNS_QUEST_SUB_SEQ
			</puts>
		</sql>
		<sql name="quest.SNSQuestSubStepUpdate" execute="Update" type="PreparedStatement" desc="추천친구 업데이트">
			<param name="SNS_QUEST_SUB_SEQ"	required="yes" 	desc="" />
			<param name="STEP"				required="yes" 	desc="" />
			<puts>
				UPDATE TB_SNS_QUEST_SUB SET STEP = $STEP WHERE SNS_QUEST_SUB_SEQ = $SNS_QUEST_SUB_SEQ
			</puts>
		</sql>
		<sql name="quest.UserSelectArray" execute="Select" type="PreparedStatement" desc="">
			<param name="STR_ACCOUNTPK"	required="yes" 	desc="" />
			<puts>
				SELECT
					A.ACCOUNTPK,
					A.ID,
					A.PROF_PIC_NM,
					A.AVATAR_CD,
					A.GENDER,
					A.INTRODUCE,
					1 + YEAR(NOW()) - A.BIRTHYEAR AS AGE
				FROM  FUNFACTORY_SNS.TB_USER A 
				WHERE A.ACCOUNTPK IN($STR_ACCOUNTPK)
			</puts>
		</sql>
		<sql name="quest.InterestSelectArray" execute="Select" type="PreparedStatement" desc="">
			<param name="STR_ACCOUNTPK"	required="yes" 	desc="" />
			<puts>
				SELECT
					A.ACCOUNTPK,
					GROUP_CONCAT(A.TAG_CD) AS STR_TAG_CD
				FROM  FUNFACTORY_SNS.TB_INTEREST_TAG A 
				WHERE A.ACCOUNTPK IN($STR_ACCOUNTPK)
				GROUP BY ACCOUNTPK
				ORDER BY ACCOUNTPK
			</puts>
		</sql>
		<sql name="quest.StarContentsTagTopSelect" execute="Select" type="PreparedStatement" desc="">
			<param name="STR_ACCOUNTPK"	required="yes" 	desc="" />
			<puts>
				SELECT 
					D.ACCOUNTPK, 
					GROUP_CONCAT(D.STAR_CONT_CD) STR_TAG_CD
				FROM 
				(
				SELECT a.ACCOUNTPK, a.STAR_CONT_CD
					FROM FUNFACTORY_STARCONT.TB_STAR_CONT a, FUNFACTORY_STARCONT.TB_STAR_CONT_COUNTER b 
					WHERE a.STAR_CONT_SEQ = b.STAR_CONT_SEQ AND a.ACCOUNTPK 
					IN( $STR_ACCOUNTPK )
					ORDER BY a.ACCOUNTPK, b.HEART_CNT + b.SMILE_CNT DESC
				 ) D
				 GROUP BY D.ACCOUNTPK;
			</puts>
		</sql>
		<sql name="quest.SnsQuestCondSelectBe" execute="Select" type="PreparedStatement" desc="">
			<param name="ACCOUNTPK"	required="yes" 	desc="" />
			<puts>
				SELECT SNSQUEST_COND_SEQ, TEAM_ACCOUNTPK, COND_TYPE, QUEST_ID
				FROM TB_SNSQUEST_COND
				WHERE ACCOUNTPK = $ACCOUNTPK and REG_DATE = READ_DATE and REG_DATE > DATE_FORMAT(NOW(), '%Y-%m-%d 03:00:00');
			</puts>
		</sql>
		<sql name="quest.SnsQuestCondSelectAf" execute="Select" type="PreparedStatement" desc="">
			<param name="ACCOUNTPK"	required="yes" 	desc="" />
			<puts>
				SELECT SNSQUEST_COND_SEQ, TEAM_ACCOUNTPK, COND_TYPE, QUEST_ID
				FROM TB_SNSQUEST_COND
				WHERE ACCOUNTPK = $ACCOUNTPK and REG_DATE = READ_DATE and REG_DATE > DATE_FORMAT(ADDDATE(NOW(), -1), '%Y-%m-%d 03:00:00');
			</puts>
		</sql>
		<sql name="quest.SnsQuestCondUpdate" execute="Select" type="PreparedStatement" desc="">
			<param name="SNSQUEST_COND_SEQ"	required="yes" 	desc="" />
			<puts>
				UPDATE TB_SNSQUEST_COND
				SET READ_DATE = NOW()
				WHERE SNSQUEST_COND_SEQ = $SNSQUEST_COND_SEQ
			</puts>
		</sql>		
		<sql name="quest.UserCurrencySelect" execute="Select" type="PreparedStatement" desc="">
			<param name="ACCOUNTPK"	required="yes" 	desc="" />
			<puts>
				SELECT
					STAR_CNT,
					GOLD_CNT,
					RUBY_CNT,
					HEART_CNT,
					COIN_CNT,
					SMILE_CNT,
					RUBY_FREE_CNT,
					SMILE_FREE_CNT
				FROM  TB_CURRENCY_INFO
				WHERE ACCOUNTPK = $ACCOUNTPK
			</puts>
		</sql>
		<sql name="quest.UserCurrencyPlus" execute="Update" type="PreparedStatement" desc="">
			<param name="ACCOUNTPK"	required="yes" 	desc="" />
			<param name="STAR_CNT"	required="yes" 	desc="" />
			<param name="GOLD_CNT"	required="yes" 	desc="" />
			<param name="RUBY_CNT"	required="yes" 	desc="" />
			<param name="HEART_CNT"	required="yes" 	desc="" />
			<param name="COIN_CNT"	required="yes" 	desc="" />
			<param name="SMILE_CNT"	required="yes" 	desc="" />
			<param name="RUBY_FREE_CNT"	required="yes" 	desc="" />
			<param name="SMILE_FREE_CNT"	required="yes" 	desc="" />
			<puts>
				UPDATE TB_CURRENCY_INFO
				SET STAR_CNT = STAR_CNT + $STAR_CNT,
					GOLD_CNT = GOLD_CNT + $GOLD_CNT,
					RUBY_CNT = RUBY_CNT + $RUBY_CNT,
					HEART_CNT = HEART_CNT + $HEART_CNT,
					COIN_CNT = COIN_CNT + $COIN_CNT,
					SMILE_CNT = SMILE_CNT + $SMILE_CNT,
					RUBY_FREE_CNT = RUBY_FREE_CNT + $RUBY_FREE_CNT,
					SMILE_FREE_CNT = SMILE_FREE_CNT + $SMILE_FREE_CNT
				WHERE ACCOUNTPK = $ACCOUNTPK
			</puts>
		</sql>
		<sql name="quest.UserCurrencyMinus" execute="Update" type="PreparedStatement" desc="">
			<param name="ACCOUNTPK"	required="yes" 	desc="" />
			<param name="STAR_CNT"	required="yes" 	desc="" />
			<param name="GOLD_CNT"	required="yes" 	desc="" />
			<param name="RUBY_CNT"	required="yes" 	desc="" />
			<param name="HEART_CNT"	required="yes" 	desc="" />
			<param name="COIN_CNT"	required="yes" 	desc="" />
			<param name="SMILE_CNT"	required="yes" 	desc="" />
			<param name="RUBY_FREE_CNT"	required="yes" 	desc="" />
			<param name="SMILE_FREE_CNT"	required="yes" 	desc="" />
			<puts>
				UPDATE TB_CURRENCY_INFO
				SET STAR_CNT = STAR_CNT - $STAR_CNT,
					GOLD_CNT = GOLD_CNT - $GOLD_CNT,
					RUBY_CNT = RUBY_CNT - $RUBY_CNT,
					HEART_CNT = HEART_CNT - $HEART_CNT,
					COIN_CNT = COIN_CNT - $COIN_CNT,
					SMILE_CNT = SMILE_CNT - $SMILE_CNT,
					RUBY_FREE_CNT = RUBY_FREE_CNT - $RUBY_FREE_CNT,
					SMILE_FREE_CNT = SMILE_FREE_CNT - $SMILE_FREE_CNT
				WHERE ACCOUNTPK = $ACCOUNTPK
			</puts>
		</sql>
		<sql name="quest.UserCurrencyUpdate" execute="Update" type="PreparedStatement" desc="">
			<param name="ACCOUNTPK"	required="yes" 	desc="" />
			<param name="STAR_CNT"	required="yes" 	desc="" />
			<param name="GOLD_CNT"	required="yes" 	desc="" />
			<param name="RUBY_CNT"	required="yes" 	desc="" />
			<param name="HEART_CNT"	required="yes" 	desc="" />
			<param name="COIN_CNT"	required="yes" 	desc="" />
			<param name="SMILE_CNT"	required="yes" 	desc="" />
			<param name="RUBY_FREE_CNT"	required="yes" 	desc="" />
			<param name="SMILE_FREE_CNT"	required="yes" 	desc="" />
			<puts>
				UPDATE TB_CURRENCY_INFO
				SET STAR_CNT	= $STAR_CNT,
					GOLD_CNT	= $GOLD_CNT,
					RUBY_CNT	= $RUBY_CNT,
					HEART_CNT	= $HEART_CNT,
					COIN_CNT	= $COIN_CNT,
					SMILE_CNT	= $SMILE_CNT,
					RUBY_FREE_CNT = $RUBY_FREE_CNT,
					SMILE_FREE_CNT = $SMILE_FREE_CNT
				WHERE ACCOUNTPK = $ACCOUNTPK
			</puts>
		</sql>
		<sql name="quest.SNSQuestAddCnt" execute="Update" type="PreparedStatement" desc="">
			<param name="SNS_QUEST_SEQ"	required="yes" 	desc="" />
			<puts>
				UPDATE TB_SNS_QUEST
				SET STEP	= STEP+1
				WHERE SNS_QUEST_SEQ = $SNS_QUEST_SEQ
			</puts>
		</sql>
		<sql name="quest.FileInfoSelect" execute="Select" type="PreparedStatement" desc="">
			<param name="POST_SEQ"	required="yes" 	desc="" />
			<puts>
				SELECT 
					POST_SEQ,
					FILE_TYPE,
					CASE WHEN (FILE_TYPE=2) THEN FUNFACTORY_SNS.F_THUMBNAIL_FILE(FILE_NM) WHEN (FILE_TYPE=3) THEN  'video_default.png' ELSE FILE_NM END FILE_NM
				FROM FUNFACTORY_SNS.TB_FILE_INFO
				WHERE POST_SEQ = $POST_SEQ
			</puts>
		</sql>
		<sql name="quest.FileInfoArrSelect" execute="Select" type="PreparedStatement" desc="">
			<param name="STR_POST_SEQ"	required="yes" 	desc="" />
			<puts>
				SELECT
					POST_SEQ,
					FILE_TYPE,
					CASE WHEN (FILE_TYPE=2) THEN FUNFACTORY_SNS.F_THUMBNAIL_FILE(FILE_NM) WHEN (FILE_TYPE=3) THEN  'video_default.png' ELSE FILE_NM END FILE_NM
				FROM FUNFACTORY_SNS.TB_FILE_INFO
				WHERE POST_SEQ IN($STR_POST_SEQ)
			</puts>
		</sql>
		<sql name="quest.StarContentsCounterSumSelect" execute="Select" type="PreparedStatement" desc="">
			<param name="ACCOUNTPK"	required="yes" 	desc="" />
			<puts>
				SELECT 
					SUM(PIC_CNT)as 'PIC_CNT', 
					SUM(VIDEO_CNT)as 'VIDEO_CNT', 
					SUM(FOLLOWER_CNT)as 'FOLLOWER_CNT', 
					SUM(SMILE_CNT)as 'SMILE_CNT' 
				FROM FUNFACTORY_STARCONT.TB_STAR_CONT_COUNTER 
				WHERE ACCOUNTPK = $ACCOUNTPK
			</puts>
		</sql>
		<sql name="quest.ShareBoxInsert" execute="Update" type="PreparedStatement" desc="">
			<param name="TO_ACCOUNTPK"	required="yes" 	desc="" />
			<param name="FROM_ACCOUNTPK"	required="yes" 	desc="" />
			<param name="POST_SEQ"	required="yes" 	desc="" />
			<param name="TILE_IDX"	required="yes" 	desc="" />
			<param name="MSG"	required="yes" 	desc="" />			
			<param name="LIMIT_TIME"	required="yes" 	desc="" />
			<puts>
				INSERT INTO TB_SHARE_BOX(TO_ACCOUNTPK, FROM_ACCOUNTPK, POST_SEQ, TILE_IDX, MSG, LIMIT_TIME) 
				VALUES($TO_ACCOUNTPK, $FROM_ACCOUNTPK, $POST_SEQ, $TILE_IDX, $MSG, ADDDATE(NOW(), interval $LIMIT_TIME SECOND))
			</puts>
		</sql>
		<sql name="quest.ShareBoxSelect" execute="Select" type="PreparedStatement" desc="">
			<param name="ACCOUNTPK"	required="yes" 	desc="" />
			<puts>
				SELECT 
					SHARE_BOX_SEQ, 
					TO_ACCOUNTPK, 
					POST_SEQ, 
					TILE_IDX, 
					MSG, 
					TIMESTAMPDIFF(second, now(), LIMIT_TIME)as 'LIMIT_TIME' 
				FROM TB_SHARE_BOX 
				WHERE FROM_ACCOUNTPK = $ACCOUNTPK and LIMIT_TIME > NOW()
			</puts>
		</sql>
		<sql name="quest.ShareBoxSelectLastSelect" execute="Select" type="PreparedStatement" desc="">
			<param name="TO_ACCOUNTPK"	required="yes" 	desc="" />
			<param name="FROM_ACCOUNTPK"	required="yes" 	desc="" />
			<puts>
				SELECT 
					SHARE_BOX_SEQ, 
					TO_ACCOUNTPK, 
					POST_SEQ, 
					TILE_IDX, 
					MSG, 
					TIMESTAMPDIFF(second, now(), LIMIT_TIME)as 'LIMIT_TIME'
				FROM TB_SHARE_BOX 
				WHERE TO_ACCOUNTPK = $TO_ACCOUNTPK AND FROM_ACCOUNTPK = $FROM_ACCOUNTPK
				ORDER BY SHARE_BOX_SEQ DESC
                LIMIT 1
			</puts>
		</sql>
		<sql name="quest.ShareBoxSelectSeq" execute="Select" type="PreparedStatement" desc="">
			<param name="SHARE_BOX_SEQ"	required="yes" 	desc="" />
			<puts>
				SELECT 
					SHARE_BOX_SEQ, 
					TO_ACCOUNTPK, 
					POST_SEQ, 
					TILE_IDX, 
					MSG, 
					TIMESTAMPDIFF(second, now(), LIMIT_TIME)as 'LIMIT_TIME' 
				FROM TB_SHARE_BOX 
				WHERE SHARE_BOX_SEQ = $SHARE_BOX_SEQ and LIMIT_TIME > NOW()
			</puts>
		</sql>
		<sql name="quest.StarContentsTopSelectA" execute="Select" type="PreparedStatement" desc="">
			<param name="ACCOUNTPK"	required="yes" 	desc="" />
			<puts>
				SELECT
					A.STAR_CONT_SEQ
				FROM
				(
				SELECT
					STAR_CONT_SEQ, (COMMENT_CNT*35 + HEART_CNT*15 + SMILE_CNT*50) as WEIGHT
				FROM
					FUNFACTORY_STARCONT.TB_STAR_CONT_COUNTER
				WHERE
						ACCOUNTPK = $ACCOUNTPK
					) A
				ORDER BY A.WEIGHT DESC
				LIMIT 1
			</puts>
		</sql>
		<sql name="quest.StarContentsTopSelectB" execute="Select" type="PreparedStatement" desc="">
			<param name="STAR_CONT_SEQ"	required="yes" 	desc="" />
			<param name="CNT"	required="yes" 	desc="" />
			<puts>
				SELECT b.STAR_CONT_SEQ , FILE_TYPE,
					CASE WHEN (FILE_TYPE=2) THEN FUNFACTORY_SNS.F_THUMBNAIL_FILE(FILE_NM) WHEN (FILE_TYPE=3) THEN  'video_default.png' ELSE FILE_NM END FILE_NM
				FROM FUNFACTORY_SNS.TB_POST a, FUNFACTORY_SNS.TB_STAR_CONT_POST b, FUNFACTORY_SNS.TB_FILE_INFO c
				WHERE a.POST_SEQ = c.POST_SEQ AND a.POST_SEQ = b.POST_SEQ AND $STAR_CONT_SEQ = b.STAR_CONT_SEQ
				ORDER BY (a.COMMENT_CNT*35 + a.HEART_CNT*15 + a.SMILE_CNT*50) DESC
				LIMIT $CNT
			</puts>
		</sql>
	</module>
</sqlm>
